import Fastify from 'fastify';
import swagger from '@fastify/swagger';
import swaggerUi from '@fastify/swagger-ui';
import { householdsRoutes } from './routes/households/index.js';
import { registerPublicMedicationRoutes } from './routes/medicationRoutes.js';
import { registerAuthContext } from './plugins/authContext.js';

export const buildApp = () => {
  const app = Fastify({
    logger: {
      redact: {
        paths: [
          'req.headers.x-user-email',
          'req.headers.authorization',
          'req.body.users[*].email',
          'req.body.token',
          'req.query.token',
        ],
        remove: true,
      },
    },
    // Allow empty bodies for DELETE requests with Content-Type: application/json
    ignoreTrailingSlash: true,
  });

  // Override default JSON parser to allow empty bodies on DELETE requests
  app.removeContentTypeParser('application/json');
  app.addContentTypeParser('application/json', { parseAs: 'string' }, (req, body, done) => {
    // Allow empty body for DELETE requests
    if (req.method === 'DELETE' && body === '') {
      done(null, undefined);
      return;
    }
    
    try {
      const json = JSON.parse(body as string);
      done(null, json);
    } catch (err: any) {
      err.statusCode = 400;
      done(err, undefined);
    }
  });

  app.get('/health', async () => {
    return { status: 'ok' };
  });

  app.register(swagger, {
    openapi: {
      info: {
        title: 'Senior Hub API',
        version: '0.1.0',
        description: 'Household onboarding and invitation management API contracts.',
      },
      tags: [{ name: 'Households' }, { name: 'Invitations' }, { name: 'Medications' }, { name: 'Observability' }],
    },
  });

  app.register(swaggerUi, {
    routePrefix: '/docs',
    staticCSP: true,
    transformSpecificationClone: true,
  });

  registerAuthContext(app);
  app.register(householdsRoutes);
  registerPublicMedicationRoutes(app);

  return app;
};
